{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2020/06/15/npm-publish-gpr/","result":{"data":{"site":{"siteMetadata":{"title":"Mitchell Simoens Blog","author":"Mitchell Simoens"}},"markdownRemark":{"id":"75b7e994-c07b-57dc-9dc6-9f031ef7b1ac","excerpt":"I’ve seen a few blogs about publishing a node module to the NPM repository and\nGitHub Package Registry (GPR). Some I like, some I don’t. I thought, what’s…","html":"<p>I’ve seen a few blogs about publishing a node module to the <a href=\"https://www.npmjs.com/\">NPM</a> repository and\n<a href=\"https://github.com/features/packages\">GitHub Package Registry (GPR)</a>. Some I like, some I don’t. I thought, what’s better than a couple\nexisting blogs about it? One more. I also have some ideas for the stuff I’ve done that may be a bit unique to\nme but the workflow I have can be easily adjusted to remove parts if that isn’t desired.</p>\n<h2>The Why</h2>\n<p>Why publish a node module to NPM and GPR? Being the default, publishing to NPM is still a great idea. However,\nlately, I’ve seen some projects start going with GPR also. Yes, installing a node module that your <code class=\"language-text\">.npmrc</code> is\ntargeting GPR will still get proxied to NPM, I still feel it could be a good idea to also publish to GitHub. I\nalso want to have a GitHub release created without just relying on a git tag.</p>\n<h2>Splitting the workflow</h2>\n<p>The workflow I will be talking about has 4 jobs:</p>\n<ul>\n<li><a href=\"#build-job\"><code class=\"language-text\">build</code></a></li>\n<li><a href=\"#release-job\"><code class=\"language-text\">release</code></a> (requires <code class=\"language-text\">build</code> job)</li>\n<li><a href=\"#publish-npm-job\"><code class=\"language-text\">publish-npm</code></a> (requires <code class=\"language-text\">build</code> job)</li>\n<li><a href=\"#publish-gpr-job\"><code class=\"language-text\">publish-gpr</code></a> (requires <code class=\"language-text\">build</code> job)</li>\n</ul>\n<p>The last three rely on the <code class=\"language-text\">build</code> job but allow those three to run in parallel. Let’s look more at each\nindividually but at the end I’ll still show the entire <code class=\"language-text\">.github/workflows/publish.yml</code> file.</p>\n<h3><code class=\"language-text\">build</code><a name=\"build-job\"></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yml line-numbers\"><code class=\"language-yml\">  <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v1\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@v1\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">14</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm ci\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm run lint\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm test\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm run build\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Zip lib &amp; node_modules\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> zip <span class=\"token punctuation\">-</span>9qry \"build.zip\" \"./\" <span class=\"token punctuation\">-</span>i \"node_modules/<span class=\"token important\">*\"</span> <span class=\"token punctuation\">-</span>i \"lib/<span class=\"token important\">*\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Upload build.zip\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/upload<span class=\"token punctuation\">-</span>artifact@v2\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> build.zip\n          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> build.zip</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>I personally use <a href=\"https://www.typescriptlang.org/\">TypeScript</a> a lot so I need do need to build it. I also like to run a quick lint check and\nrun tests as this is the last opportunity to stop a release.I also zip up the build artifacts (<code class=\"language-text\">node_modules</code>\nand <code class=\"language-text\">lib</code> in this case) and then upload them so the subsequent steps can download it and use it.</p>\n<p>One thing not to overlook is when installing I use <code class=\"language-text\">npm ci</code> instead of <code class=\"language-text\">npm i</code> so that I only install what is\nin the lock file and nothing possibly new. I see people using <code class=\"language-text\">npm i</code> far too many times even during\ndevelopment. Updating dependencies should be a planned thing and not happen just whenever anyone feels like it.</p>\n<p>If you don’t use TypeScript or anything else that would require a build, you can simply remove that step and\nthe <code class=\"language-text\">lib</code> dir from the zipping but I still would zip and upload the <code class=\"language-text\">node_modules</code> dir. This would then look\nlike this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yml line-numbers\"><code class=\"language-yml\">  <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v1\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@v1\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">14</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm ci\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm run lint\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm test\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Zip lib &amp; node_modules\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> zip <span class=\"token punctuation\">-</span>9qry \"build.zip\" \"./\" <span class=\"token punctuation\">-</span>i \"node_modules/<span class=\"token important\">*\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Upload build.zip\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/upload<span class=\"token punctuation\">-</span>artifact@v2\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> build.zip\n          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> build.zip</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>The same would be true if you didn’t have or didn’t want to run the lint check or tests.</p>\n<h3><code class=\"language-text\">release</code><a name=\"release-job\"></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yml line-numbers\"><code class=\"language-yml\">  <span class=\"token key atrule\">release</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">needs</span><span class=\"token punctuation\">:</span> build\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Create GitHub Release\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@master\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Download build.zip\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/download<span class=\"token punctuation\">-</span>artifact@v2\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> build.zip\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Create Release\n        <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> create_release\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/create<span class=\"token punctuation\">-</span>release@v1\n        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">GITHUB_TOKEN</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.GITHUB_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">tag_name</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.ref <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">release_name</span><span class=\"token punctuation\">:</span> Release $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.ref <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">body</span><span class=\"token punctuation\">:</span> Stuff happened\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Upload Release Asset\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/upload<span class=\"token punctuation\">-</span>release<span class=\"token punctuation\">-</span>asset@v1\n        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">GITHUB_TOKEN</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.GITHUB_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">upload_url</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> steps.create_release.outputs.upload_url <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">asset_path</span><span class=\"token punctuation\">:</span> ./build.zip\n          <span class=\"token key atrule\">asset_name</span><span class=\"token punctuation\">:</span> build.zip\n          <span class=\"token key atrule\">asset_content_type</span><span class=\"token punctuation\">:</span> application/zip</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>This is where things start happening. Creating GitHub releases is a great thing as it allows you to hold build\nartifacts and have some body describing things in that release. There are many ways to build the body of the\nrelease so I left it simple in this workflow as I’ve had to do many different things. Notice here, we download\nthe zipped build artifact but we don’t unzip it. We upload that zip to the release after it has been created.\nThe reason for this is when the <code class=\"language-text\">create_release</code> step executes, it actually hits GitHubs create release API\nwhich then uses the source for that tag. This is important as it does not create a release from what is\ncurrently on disk so if you did this after a build (or unzipped the build artifact), that wouldn’t show up\nin the GitHub release.</p>\n<p>I think it’s important to upload the build artifact to the GitHub release so you have that zip bound to that\nrelease which does include the <code class=\"language-text\">node_modules</code> dir. This is important because many people have dependencies in\ntheir <code class=\"language-text\">package.json</code> with a prefix meaning the versions of the dependencies are not locked. When not locked,\nyou can never count on installing that exact version without some work. So upload the build artifact and you\nare good to go without any work.</p>\n<p>If you don’t know, when you see <code class=\"language-text\">${{ secrets.GITHUB_TOKEN }}</code> that does not mean you need to go into the repo\nsettings and add a secret. That is a special secret that is generated for you when it’s used. Also, the\n<code class=\"language-text\">actions/create-release</code> action specially handles the <code class=\"language-text\">${{ github.ref }}</code> to strip away the <code class=\"language-text\">refs/tags/</code> part\nto just have the actual tag name. So the <code class=\"language-text\">${{ github.ref }}</code> would really look like <code class=\"language-text\">refs/tags/v1.0.0</code> but\nit removes it and so you’d just have <code class=\"language-text\">v1.0.0</code>.</p>\n<h3><code class=\"language-text\">publish-npm</code><a name=\"publish-npm-job\"></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yml line-numbers\"><code class=\"language-yml\">  <span class=\"token key atrule\">publish-npm</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">needs</span><span class=\"token punctuation\">:</span> build\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v1\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@v1\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">14</span>\n          <span class=\"token key atrule\">registry-url</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//registry.npmjs.org/\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Download build.zip\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/download<span class=\"token punctuation\">-</span>artifact@v2\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> build.zip\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Unzip build.zip\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> unzip <span class=\"token punctuation\">-</span>q build.zip\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm publish <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>access public\n        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">NODE_AUTH_TOKEN</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>secrets.PUBLISH_NPM_TOKEN<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Publishing to NPM step is pretty simple. We setup node setting the registry url to NPM, then download the\nbuild artifact from the <a href=\"#build-job\"><code class=\"language-text\">build</code></a> step, unzip it so that the <code class=\"language-text\">lib</code> directory is present and then\nrun <code class=\"language-text\">npm publish</code>. This step does require you to create a token over on <a href=\"https://www.npmjs.com/\">NPM</a> and add it as a secret to your\nrepo settings.</p>\n<h3><code class=\"language-text\">publish-gpr</code><a name=\"publish-gpr-job\"></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yml line-numbers\"><code class=\"language-yml\">  <span class=\"token key atrule\">publish-gpr</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">needs</span><span class=\"token punctuation\">:</span> build\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v1\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@v1\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">14</span>\n          <span class=\"token key atrule\">registry-url</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//npm.pkg.github.com/\n          <span class=\"token key atrule\">scope</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'@mitchellsimoens'</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Download build.zip\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/download<span class=\"token punctuation\">-</span>artifact@v2\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> build.zip\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Unzip build.zip\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> unzip <span class=\"token punctuation\">-</span>q build.zip\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm publish\n        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">NODE_AUTH_TOKEN</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>secrets.PUBLISH_GITHUB_TOKEN<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>The publish to GPR is very similar to the <a href=\"#publish-npm-job\"><code class=\"language-text\">publish-npm</code></a> but there are a few differences.\nFirst, when we setup node we give it a different registry-url but we also need to specify the scope. All this\nis is the username or organization name the repo is under. So for me, if I have the repo\n<a href=\"https://github.com/mitchellsimoens/foo\">https://github.com/mitchellsimoens/foo</a> then <code class=\"language-text\">@mitchellsimoens</code> is the scope. The next difference is of course\nwe need a <a href=\"https://github.com/settings/tokens\">GitHub token</a> which needs the <code class=\"language-text\">write:packages</code> scope (this will\nalso automatically check all the <code class=\"language-text\">repo.*</code> and <code class=\"language-text\">read:packages</code> scopes). A keen eye also would notice that the\n<code class=\"language-text\">npm publish</code> here doesn’t have the <code class=\"language-text\">--access public</code> because with GPR the access is determined by the scopes\non the user token being used.</p>\n<h2>The whole workflow</h2>\n<p>The whole workflow is mostly all of the above concatenated but it also includes what triggers the workflow. I\nhave mine trigger when a tag with the <code class=\"language-text\">v</code> prefix is pushed. This means, I run <code class=\"language-text\">npm version patch</code> (or whatever\nversion) and then push the commit and tag up. I’ve seen some people push all tags (<code class=\"language-text\">git push --tags</code>) which is\nfine but if there are any other tags with <code class=\"language-text\">v</code> prefix in it that have not been pushed you could trigger unwanted\npublishes so you may want to push a single tag like <code class=\"language-text\">git push origin v1.0.0</code>. Up to you if you care about that.</p>\n<p>Ok, here is the full workflow I normally put as <code class=\"language-text\">.github/workflow/publish.yml</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yml line-numbers\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Publish\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'v*'</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v1\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@v1\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">14</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm ci\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm run lint\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm run build\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Zip lib &amp; node_modules\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> zip <span class=\"token punctuation\">-</span>9qry \"build.zip\" \"./\" <span class=\"token punctuation\">-</span>i \"node_modules/<span class=\"token important\">*\"</span> <span class=\"token punctuation\">-</span>i \"lib/<span class=\"token important\">*\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Upload build.zip\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/upload<span class=\"token punctuation\">-</span>artifact@v2\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> build.zip\n          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> build.zip\n\n  <span class=\"token key atrule\">release</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">needs</span><span class=\"token punctuation\">:</span> build\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Create GitHub Release\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@master\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Download build.zip\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/download<span class=\"token punctuation\">-</span>artifact@v2\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> build.zip\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Create Release\n        <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> create_release\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/create<span class=\"token punctuation\">-</span>release@v1\n        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">GITHUB_TOKEN</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.GITHUB_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">tag_name</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.ref <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">release_name</span><span class=\"token punctuation\">:</span> Release $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.ref <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Upload Release Asset\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/upload<span class=\"token punctuation\">-</span>release<span class=\"token punctuation\">-</span>asset@v1\n        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">GITHUB_TOKEN</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.GITHUB_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">upload_url</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> steps.create_release.outputs.upload_url <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">asset_path</span><span class=\"token punctuation\">:</span> ./build.zip\n          <span class=\"token key atrule\">asset_name</span><span class=\"token punctuation\">:</span> build.zip\n          <span class=\"token key atrule\">asset_content_type</span><span class=\"token punctuation\">:</span> application/zip\n\n  <span class=\"token key atrule\">publish-npm</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">needs</span><span class=\"token punctuation\">:</span> build\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v1\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@v1\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">14</span>\n          <span class=\"token key atrule\">registry-url</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//registry.npmjs.org/\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Download build.zip\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/download<span class=\"token punctuation\">-</span>artifact@v2\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> build.zip\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Unzip build.zip\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> unzip <span class=\"token punctuation\">-</span>q build.zip\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm publish <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>access public\n        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">NODE_AUTH_TOKEN</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>secrets.PUBLISH_NPM_TOKEN<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n  <span class=\"token key atrule\">publish-gpr</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">needs</span><span class=\"token punctuation\">:</span> build\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v1\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@v1\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">14</span>\n          <span class=\"token key atrule\">registry-url</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//npm.pkg.github.com/\n          <span class=\"token key atrule\">scope</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'@mitchellsimoens'</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Download build.zip\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/download<span class=\"token punctuation\">-</span>artifact@v2\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> build.zip\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Unzip build.zip\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> unzip <span class=\"token punctuation\">-</span>q build.zip\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm publish\n        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">NODE_AUTH_TOKEN</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>secrets.PUBLISH_GITHUB_TOKEN<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>","fields":{"readingTime":{"text":"8 min read"},"slug":"/2020/06/15/npm-publish-gpr/"},"frontmatter":{"title":"NPM Publish to GPR and NPM","date":"June 25, 2020"}}},"pageContext":{"slug":"/2020/06/15/npm-publish-gpr/","previous":{"fields":{"slug":"/2020/03/18/health-update/"},"frontmatter":{"title":"Health Update"}},"next":null}}}