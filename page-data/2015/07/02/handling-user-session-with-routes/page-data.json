{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2015/07/02/handling-user-session-with-routes/","webpackCompilationHash":"8bfc8b7fa9836efccfc8","result":{"data":{"site":{"siteMetadata":{"title":"Mitchell Simoens Blog","author":"Mitchell Simoens"}},"markdownRemark":{"id":"88d686cc-5734-55a4-a8bc-8e9e20a5b3a0","excerpt":"I’d like to first state that there are literally thousands of ways to handle this and is dependent on how you handle user sessions within your application…","html":"<p>I’d like to first state that there are literally thousands of ways to handle this and is dependent on how you handle user sessions within your application.</p>\n<h3>Simple Beginnings</h3>\n<p>In almost every Ext JS application I’ve built I’ve had to deal with user sessions. Most apps require login before entering the application (like the <a href=\"https://support.sencha.com\">support portal</a>, new one on the way too!), some allow you to use parts of the app without a login (like <a href=\"https://fiddle.sencha.com\">Sencha Fiddle</a>, new on on the way too!). At the start of the application I check to see if there is an active user session from the server. I personally use Ext.Direct to do this but I’ll stick with a plain <code class=\"language-text\">Ext.Ajax</code> request:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">Ext.Ajax.request({\n    url     : &#39;/session&#39;,\n    failure : function() {},\n    success : function(response) {\n        MyApp.user = Ext.decode(response.responseText);\n    }\n});</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>This code is simplified and not complete but what’s happening is when the request succeeds decode the JSON and set it to the <code class=\"language-text\">user</code> property on the <code class=\"language-text\">MyApp</code> namespace. If the request fails (returning a 403 for example), there is no session. I’ll state again, this code is simplified and not complete, just showing an example and saving it to <code class=\"language-text\">MyApp.user</code> for ease of retrieval. (and yes, you can use promises with Ext JS 6 instead of callbacks but that has nothing to do with this)</p>\n<p>When an application starts, it may have a hash in the URI and therefore Ext JS is going to take action on it. This will likely be before the above <code class=\"language-text\">Ext.Ajax.request</code> is finished which would cause an issue. If the user is already logged in, then the route may be ok to execute but if there is no session, you need to prevent the route from executing and redirect them to the login. For this, I use the <code class=\"language-text\">before</code> config on my routes and check <code class=\"language-text\">MyApp.app</code> and take appropriate action. Here is a simple controller to show this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">Ext.define(&#39;MyApp.view.MainController&#39;, {\n    extend : &#39;Ext.app.ViewController&#39;,\n    alias  : &#39;controller.myapp-main&#39;,\n\n    routes : {\n        &#39;user&#39; : {\n            before : &#39;checkSession&#39;,\n            action : &#39;showUser&#39;\n        }\n    },\n\n    checkSession : function() {\n        var args   = Ext.Array.slice(arguments),\n            action = args[args.length - 1];\n\n        if (MyApp.user) {\n            action.resume();\n        } else {\n            action.stop();\n\n            this.redirectTo(&#39;login&#39;);\n        }\n    },\n\n    showUser : function() {}\n});</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Inspecting this controller, we have a single route with the <code class=\"language-text\">before</code> and <code class=\"language-text\">action</code> configs. In the before, we get the action argument (it’ll always be the last argument but some routes may have many arguments), check if <code class=\"language-text\">MyApp.user</code> exists and if so then resume the action. If it’s not, we stop it and then redirect the app to the <code class=\"language-text\">#login</code> hash.</p>\n<p>So now, the <code class=\"language-text\">user</code> route requires a user session. If you have a route that doesn’t require a user session, you can simply remove not have the <code class=\"language-text\">before</code> config and it will execute regardless of the <code class=\"language-text\">checkSession</code> method.</p>\n<p><strong>Side Note:</strong> Each action would need to have the <code class=\"language-text\">before</code> config. We do have some feature requests to help in this area to have a single before action that will execute for all routes.</p>\n<h3>More Advanced</h3>\n<p>That’s great but a keen mind will understand that if the <code class=\"language-text\">Ext.Ajax.request</code> finishes after the <code class=\"language-text\">checkSession</code> method executes from an initial route execution, the action will be stopped regardless if that user session check was successful. Not good. For this I set a property signifying the app is ready and fire an event on the application instance. This way the <code class=\"language-text\">checkSession</code> method can tell if the app is actually ready to handle things. First, let’s look at how the <code class=\"language-text\">Ext.Ajax.request</code> would be changed to do this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">launch : function() {\n    Ext.Ajax.request({\n        url     : &#39;/session&#39;,\n        scope   : this,\n        failure : function() {\n            this.onUser();\n        },\n        success : function(response) {\n            this.onUser(\n                MyApp.user = Ext.decode(response.responseText);\n            );\n        }\n    });\n},\n\nonUser : function(user) {\n    this.appready = true;\n    this.fireEvent(&#39;appready&#39;, this, user);\n}</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>This would be code you can have in your <code class=\"language-text\">app/Application.js</code>. In the <code class=\"language-text\">failure</code> and <code class=\"language-text\">success</code> callbacks, I execute the <code class=\"language-text\">onUser</code> method. In this method, I set the <code class=\"language-text\">appready</code> property to <code class=\"language-text\">true</code> so anything can check <code class=\"language-text\">MyApp.app.appready</code> to see if it’s ready. Along with the property, the application also will fire the <code class=\"language-text\">appready</code> event passing the application (it’s a convention to pass the class firing the event as the first parameter) and the user if one was set. So now we can react to both the property and event in our <code class=\"language-text\">before</code> action:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">checkSession : function() {\n    var me     = this,\n        args   = Ext.Array.slice(arguments),\n        action = args[args.length - 1],\n        app    = MyApp.app;\n\n    if (app.appready) {\n        if (MyApp.user) {\n            action.resume();\n        } else {\n            action.stop();\n\n            me.redirectTo(&#39;login&#39;);\n        }\n    } else {\n        app.on(\n            &#39;appready&#39;,\n            Ext.Function.bind(me.checkSession, me, args),\n            me,\n            { single : true }\n        );\n    }\n}</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>In this new <code class=\"language-text\">checkSession</code> method I do a few things. First I set an <code class=\"language-text\">app</code> variable to <code class=\"language-text\">MyApp.app</code>, this is your application instance where we set the <code class=\"language-text\">appready</code> property. If the <code class=\"language-text\">appready</code> property is <code class=\"language-text\">true</code> then we know the user session check has already happened and therefore we can check the <code class=\"language-text\">user</code> property and resume/stop the action. If the <code class=\"language-text\">appready</code> property is <code class=\"language-text\">false</code> then we need to add a listener to the <code class=\"language-text\">appready</code> event. The reason I use <code class=\"language-text\">Ext.Function.bind</code> is because I need to control what arguments are passed when the event is fired so that the <code class=\"language-text\">action</code> argument is the last argument. With this function binding, I know the arguments will be the same as when it originally was executed. And lastly I make sure that when the event is first listened to it will remove itself with the <code class=\"language-text\">single</code> event option.</p>\n<p>So now if the <code class=\"language-text\">MyApp.app.appready</code> property is <code class=\"language-text\">false</code>, the user session request is still happening. When that request finishes, successful or not, the <code class=\"language-text\">checkSession</code> method listen for the <code class=\"language-text\">appready</code> event to fire signifying the user session was completed.</p>\n<h3>Even More Advanced</h3>\n<p>To go a step further, I often have to deal with different user types like normal user and admin. Admins should have access to certain parts of the application a user should not and therefore we need to stop a user trying to gain access. For this, I have a separate method that will look like <code class=\"language-text\">checkSession</code> but will check what kind of user is present:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">checkIsAdmin : function() {\n    var me     = this,\n        args   = Ext.Array.slice(arguments),\n        action = args[args.length - 1],\n        app    = MyApp.app;\n\n    if (app.appready) {\n        if (MyApp.user) {\n            if (MyApp.user.user_type === &#39;admin&#39;) {\n                action.resume();\n            } else {\n                action.stop();\n\n                me.redirectTo(&#39;home&#39;);\n            }\n        } else {\n            action.stop();\n\n            me.redirectTo(&#39;login&#39;);\n        }\n    } else {\n        app.on(\n            &#39;appready&#39;,\n            Ext.Function.bind(me.checkSession, me, args),\n            me,\n            { single : true }\n        );\n    }\n}</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>In this before action the difference is within the first conditional. If <code class=\"language-text\">MyApp.user</code> is <code class=\"language-text\">truthy</code> then we need to check the type of user. If the user is an admin, resume the action. If not, stop the action and send the user back to <code class=\"language-text\">#home</code>. Now, to not have duplicate code you can have a shared method:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">handleSessionCheck : function(beAdmin, args) {\n    args = Ext.Array.slice(args);\n\n    var me     = this,\n        action = args[args.length - 1],\n        app    = MyApp.app;\n\n    if (app.appready) {\n        if (MyApp.user) {\n            if (!beAdmin || MyApp.user.user_type === &#39;admin&#39;) {\n                action.resume();\n            } else {\n                action.stop();\n\n                me.redirectTo(&#39;home&#39;);\n            }\n        } else {\n            action.stop();\n\n            me.redirectTo(&#39;login&#39;);\n        }\n    } else {\n        app.on(\n            &#39;appready&#39;,\n            Ext.Function.bind(me.handleSessionCheck, me, [beAdmin, args]),\n            me,\n            { single : true }\n        );\n    }\n},\n\ncheckSession : function() {\n    this.handleSessionCheck(false, arguments);\n},\n\ncheckIsAdmin : function() {\n    this.handleSessionCheck(true, arguments);\n}</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>As you can see, <code class=\"language-text\">checkSession</code> and <code class=\"language-text\">checkIsAdmin</code> both simply execute the <code class=\"language-text\">handleSessionCheck</code> method but pass whether or not the user is required to be an admin and the arguments. <code class=\"language-text\">handleSessionCheck</code> looks very similar to the old <code class=\"language-text\">checkIsAdmin</code> method except for a couple different changes. First is the conditional check the user type, it first checks if <code class=\"language-text\">beAdmin</code> is falsey, if so then it will allow the route to be resumed other wise it’ll check if the user is an admin. The other change is to the <code class=\"language-text\">Ext.Function.bind</code> in the <code class=\"language-text\">appready</code> event listener. I changed the function being bound and also the third argument is now an array of the <code class=\"language-text\">handleSessionCheck</code> arguments. This allows code reuse in a dynamic fashion which is good!</p>\n<h3>Conclusion</h3>\n<p>Being able to handle user sessions with routes really isn’t hard but there isn’t a decent example that I’ve seen. The code snippets I provided are simplified but should show the techniques I employ in my Ext JS application.</p>","fields":{"slug":"/2015/07/02/handling-user-session-with-routes/"},"frontmatter":{"title":"Handling user session with routes","date":"July 02, 2015"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2015/07/02/handling-user-session-with-routes/","previous":{"fields":{"slug":"/2015/07/02/delaying-launch-for-stores-to-load/"},"frontmatter":{"title":"Delaying launch for stores to load"}},"next":{"fields":{"slug":"/2015/07/03/saving-hierarchal-data-in-mysql-with-node-js/"},"frontmatter":{"title":"Saving hierarchical data in MySQL with Node.js"}}}}}