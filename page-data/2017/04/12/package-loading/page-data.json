{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2017/04/12/package-loading/","webpackCompilationHash":"404118be10adc6e8f540","result":{"data":{"site":{"siteMetadata":{"title":"Mitchell Simoens Blog","author":"Mitchell Simoens"}},"markdownRemark":{"id":"b3ff6256-3c18-51e0-a0f8-73e90d639bdd","excerpt":"Note This blog is talking about features that are not yet released and can change at any time prior to launch. Story Back in 2011, I was part of a contract for…","html":"<p><strong>Note</strong> This blog is talking about features that are not yet released and can change at any time prior to launch.</p>\n<h2>Story</h2>\n<p>Back in 2011, I was part of a contract for a very large financial company. This company had several departments (each department had to have it’s own PO too, silos are fun) but the company was wanting a single business to business (b2b) application that all it’s internal departments would take part of to interface with external businesses.</p>\n<p>This application would be in the millions of lines of code and we had to support IE6. At the time, Ext JS 3 was a very stable platform, however, serving a single JavaScript file that contained millions of lines of code to IE6 was just not going to work. Furthermore, we didn’t want to split the single file into loading several files at startup; basically we didn’t want startup time to be huge while it loads all that code. So we engineered a means of module loading so we only load what we need at any given time. Architecting this large application into modules was a good idea anyway to keep one silo’d department from working on the same code as another silo’d department.</p>\n<p>Ext JS never supported this module loading, that’s about to change. Together with Sencha Cmd 6.5, Ext JS applications will have support for module loading! I wanted to take a moment to discuss how to get this to work, it’s actually really simple. Sencha Cmd supports the concept of packages and each package can require or even extend another package, these packages are key to this loading as each package can be chosen to be loaded on the fly. In <code class=\"language-text\">app.json</code>, there is a new <code class=\"language-text\">uses</code> entry that is an array just like <code class=\"language-text\">requires</code>. This means, the application will use the package but it’s not required to be bundled within the application. Cmd can then build the package as part of an application build but keep the package’s source separate from the application so that you can load it on demand.</p>\n<h2>Let’s Code</h2>\n<p>First, we need to grab a copy of Ext JS 6.2 (this may change to 6.5 but currently I’m using the latest 6.2.2 nightly build) and use Sencha Cmd <strong>6.5</strong> (6.5.0 will be the minimum version required for Cmd) to generate a modern toolkit Ext JS application. <em>For this test, I’m using Ext JS 6.2.2.309 and Cmd 6.5.0.146</em></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">sencha --sdk /path/to/ext generate app -modern MyApp /path/to/MyApp</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Let’s get into the application and run a dev build:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">cd /path/to/MyApp\nsencha app build --dev</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>If you load up the application (<a href=\"http://localhost/MyApp\">http://localhost/MyApp</a> for me) you will see a tab panel with bottom tabs, first tab has a grid with the others having some simple lorem ipsum text. We now need to require the <code class=\"language-text\">package-loader</code> package that Cmd will download and install into your application automatically. To do this, we just need to add that package to the <code class=\"language-text\">requires</code> array in <code class=\"language-text\">app.json</code> which will look like:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">&quot;requires&quot;: [\n    &quot;font-awesome&quot;,\n    &quot;package-loader&quot;\n],</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>We need to now refresh the application:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">sencha app refresh</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>If you look at <code class=\"language-text\">/path/to/MyApp/packages/remote</code> you will see the <code class=\"language-text\">package-loader</code> package now. Right now, we don’t have any packages to load so let’s generate a package for three of the tabs (Users, Groups and Settings):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">sencha generate package -require Users \\\n    then generate package -require Groups \\\n    then generate package -require Settings</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p><strong>Note</strong> the <code class=\"language-text\">-require</code> switch is there to prevent Cmd from adding the new packages to the <code class=\"language-text\">requires</code> array.</p>\n<p>If you were to look in <code class=\"language-text\">/path/to/MyApp/packages/local</code> you will now see all three packages listed there now. In each package, let’s add a main view and let’s call them all <code class=\"language-text\">MyApp.view.&lt;pkgname&gt;.Main</code> where <code class=\"language-text\">&lt;pkgname&gt;</code> is the package name so we’d have <code class=\"language-text\">MyApp.view.groups.Main</code>, <code class=\"language-text\">MyApp.view.settings.Main</code> and <code class=\"language-text\">MyApp.view.users.Main</code>. Here is the source with the file location for the three views:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">// /path/to/MyApp/package/local/Groups/src/Main.js\nExt.define(&#39;MyApp.view.groups.Main&#39;, {\n    extend : &#39;Ext.Component&#39;,\n    xtype  : &#39;myapp-groups-main&#39;,\n\n    html    : &#39;This is the &lt;strong&gt;groups&lt;/strong&gt; view!&#39;,\n    padding : 20\n};\n\n// /path/to/MyApp/package/local/Settings/src/Main.js\nExt.define(&#39;MyApp.view.settings.Main&#39;, {\n    extend : &#39;Ext.Component&#39;,\n    xtype  : &#39;myapp-settings-main&#39;,\n\n    html    : &#39;This is the &lt;strong&gt;settings&lt;/strong&gt; view!&#39;,\n    padding : 20\n});\n\n// /path/to/MyApp/package/local/Users/src/Main.js\nExt.define(&#39;MyApp.view.users.Main&#39;, {\n    extend : &#39;Ext.Component&#39;,\n    xtype  : &#39;myapp-users-main&#39;,\n\n    html    : &#39;This is the &lt;strong&gt;users&lt;/strong&gt; view!&#39;,\n    padding : 20\n});</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Ok, very simple views but just enough to hopefully show a couple things. First, I want to point out that I am nesting the classes within the package in both the class name and xtype/alias. This is more optional but I think it’s important to do so for architecture purposes. I also named each class <code class=\"language-text\">Main</code>, this is a common pattern for the entry class for applications and packages but you can name it whatever you want. I’d pick something common for all your packages so the logic within your app is minimal.</p>\n<p>At this point, the application doesn’t know about these packages let alone the class within each. Like I mentioned before, we need to add the packages to the <code class=\"language-text\">uses</code> array in <code class=\"language-text\">app.json</code>, I like to place this array next to the <code class=\"language-text\">requires</code> array just to keep similar things close to each other so I’d have:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">&quot;requires&quot;: [\n    &quot;font-awesome&quot;,\n    &quot;package-loader&quot;\n],\n\n&quot;uses&quot;: [\n    &quot;Groups&quot;,\n    &quot;Settings&quot;,\n    &quot;Users&quot;\n],</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Let’s run another build with a tweak to tell Cmd to look for the <code class=\"language-text\">uses</code> array:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">sencha app build --dev --uses</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>You will see this will take a bit more time as it has to build those three packages and then build the app so essentially we are building four apps. It’s not only bundling the JavaScript sources, it will also use fashion to compile the <code class=\"language-text\">scss</code> files into a CSS file. Now that all the bootstrap data has been generated, we can now start using that <code class=\"language-text\">package-loader</code> package to load our package’s JavaScript and CSS files. Let’s prepare first by editing <code class=\"language-text\">/path/to/MyApp/app/view/main/Main.js</code> to add an <code class=\"language-text\">activate</code> listener and make the <code class=\"language-text\">items</code> array be:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">items: [{\n    title: &#39;Home&#39;,\n    iconCls: &#39;x-fa fa-home&#39;,\n    layout: &#39;fit&#39;,\n    items: [{\n        xtype: &#39;mainlist&#39;\n    }]\n}, {\n    title: &#39;Users&#39;,\n    iconCls: &#39;x-fa fa-user&#39;,\n    layout: &#39;fit&#39;,\n    pkg: &#39;Users&#39;\n}, {\n    title: &#39;Groups&#39;,\n    iconCls: &#39;x-fa fa-users&#39;,\n    layout: &#39;fit&#39;,\n    pkg: &#39;Groups&#39;\n}, {\n    title: &#39;Settings&#39;,\n    iconCls: &#39;x-fa fa-cog&#39;,\n    layout: &#39;fit&#39;,\n    pkg: &#39;Settings&#39;\n}],\n\nlisteners: {\n    activeitemchange: &#39;onItemActivate&#39;\n}</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Let’s pause and see what we are expecting here. The first tab (<code class=\"language-text\">Home</code>) will use <code class=\"language-text\">mainlist</code> which is <code class=\"language-text\">List.js</code> in the application, this isn’t going to use the package loading but could if you choose too. The other three tabs have removed the <code class=\"language-text\">bind</code> statement and added the <code class=\"language-text\">layout</code> and <code class=\"language-text\">pkg</code> configs. The <code class=\"language-text\">layout</code> config is an Ext JS config as we need the tab to be present so the user can click on something but there are no items or anything as when we load the associated package (defined by the <code class=\"language-text\">pkg</code> custom config) we are going to add the <code class=\"language-text\">Main</code> view to this tab so fit layout is needed in this case. The listener is there to tell the controller about the tab change so that we can decide if we need to load the package or not.</p>\n<p>If you were to look at the app, the <code class=\"language-text\">Home</code> tab stayed the same but the other three tabs will show a blank screen because the tabs have no child items. We need to edit <code class=\"language-text\">/path/to/MyApp/app/view/main/MainController.js</code> to require the <code class=\"language-text\">Ext.Package</code> class that comes from the <code class=\"language-text\">package-loader</code> package by adding this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">requires: [\n    &#39;Ext.Package&#39;\n],</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>Now we need to handle the <code class=\"language-text\">activeitemchange</code> event. For this, let’s a couple methods to <code class=\"language-text\">MainController</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">onItemActivate: function (tabpanel, tab) {\n    var pkg = tab.pkg;\n\n    if (pkg) {\n        if (Ext.Package.isLoaded(pkg)) {\n            this.handlePackage(pkg);\n        } else {\n            tabpanel.setMasked({\n                message: &#39;Loading Package...&#39;\n            });\n\n            Ext.Package\n                .load(pkg)\n                .then(this.handlePackage.bind(this, pkg));\n        }\n    }\n},\n\nhandlePackage: function (pkg) {\n    var tabpanel = this.getView(),\n        tab = tabpanel.child(&#39;[pkg=&#39; + pkg + &#39;]&#39;);\n\n    tabpanel.setMasked(null);\n\n    //only add item if the item isn&#39;t already added\n    if (!tab.hasPkgItem) {\n        tab.hasPkgItem = true;\n\n        tab.add({\n            xclass: &#39;MyApp.view.&#39; + pkg.toLowerCase() + &#39;.Main&#39;\n        });\n    }\n}</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>In <code class=\"language-text\">onItemActivate</code>, if the tab has the <code class=\"language-text\">pkg</code> property, we need to check to see if the package is loaded or not. If it is, go ahead and jump to <code class=\"language-text\">handlePackage</code> but if not then we need to tell <code class=\"language-text\">Ext.Package</code> to load the package and then go to <code class=\"language-text\">handlePackage</code>. If a load is required, I like to mask the app so we don’t get racing conditions because the user clicked on something else. Within <code class=\"language-text\">handlePackage</code>, we have to get the tab, unmask the tab panel and check if the tab has the <code class=\"language-text\">Main</code> class already. For performance, I tend to set a property on the tab that can easily be checked. If it hasn’t been set, then we need to add the item with the generated class name; this is where having a common name format can help but this will depend on what your application is doing.</p>\n<p>Now if you load the app and click through the tabs, you will notice when a tab is first activated, it will load the bundled JavaScript and CSS assets and will then add the <code class=\"language-text\">Main</code> view to the appropriate tab and that’s it!</p>\n<h2>Summary</h2>\n<p>This was a simple example of how Sencha Cmd 6.5 and Ext JS are employing this dynamic package loading. Once Sencha Cmd 6.5 is released, we will have examples that are similar to this along with guides about some other Cmd commands instead of just the <code class=\"language-text\">sencha app build --dev --uses</code> that we used to accomplish some other things like working with packages in development without rerunning builds all the time.</p>\n<p>Imaging the possibilities with this. Startup times will improve since you can load only the core of the application and then load what you need as the user uses the application. I work a lot with user sessions and different permissions so I can see my server disallowing loading of a package based on the session since you cannot trust the client giving better security. Lots of great things now come from this and we hope you enjoy it!</p>","fields":{"slug":"/2017/04/12/package-loading/"},"frontmatter":{"title":"Package Loading on the Fly","date":"April 12, 2017"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2017/04/12/package-loading/","previous":{"fields":{"slug":"/2016/12/20/new-router-for-ext-js/"},"frontmatter":{"title":"New Router for Ext JS"}},"next":{"fields":{"slug":"/2017/08/21/6-6-router-improvements/"},"frontmatter":{"title":"6.6 Router Improvements"}}}}}